---
title: "Untitled"
author: "Elsie Horne"
date: "23/06/2020"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r libraries, message=FALSE}
library(tidyverse)
```

```{r data, message=FALSE}
rc_ethnicity <- read_csv('rc_ethnicity.csv')
```

## test

I use the ethnicity codes specified by OpenSafely: https://github.com/opensafely/codelist-development/issues/7#issuecomment-620206708  

```{r}
rc_ethnicity %>%
  filter(!is.na(cat_vision_2), !is.na(cat_opensafely_2)) %>%
  select(read_code, cat_vision_2, cat_opensafely_2) %>%
  arrange(cat_opensafely_2) %>% 
  print(n=50)
```
 These correspond nicely, so cat_version_2 can be used to categorise version 2 Read codes, which are not in the OpenSafely list (OpenSafely only covers version 3).
 
```{r}
rc_ethnicity <- rc_ethnicity %>%
  mutate(cat_final = case_when(!is.na(cat_opensafely_2) ~ cat_opensafely_2,
                               cat_vision_2 == 'Asian or Asian British: Chinese' ~ 'Other',
                               str_detect(cat_vision_2, '^Asian') ~ 'Asian British',
                               str_detect(cat_vision_2, '^Black') ~ 'Black',
                               str_detect(cat_vision_2, '^Other') ~ 'Other',
                               str_detect(cat_vision_2, '^White') ~ 'White',
                               TRUE ~ NA_character_
                               ))
```

Try joining on Read codes, in case any read_term matches, but not read_code (i.e. different versions of Read code). Remove the census year.

```{r}
read_term_join <- rc_ethnicity %>% 
  rename(read_term = read_term_1) %>%
  # rows which have a final catego
  filter(!is.na(cat_final)) %>%
  select(read_term, cat_final) %>%
  # remove the census year
  mutate(join_var = str_trim(str_remove(read_term, '20..'), side = 'right')) %>%
  select(join_cat_final = cat_final, join_var)

rc_ethnicity <- rc_ethnicity %>% 
  rename(read_term = read_term_1) %>%
  # remove the census year
  mutate(join_var = str_trim(str_remove(read_term, '20..'), side = 'right')) %>%
  left_join(read_term_join, by = 'join_var') %>%
  mutate_at('cat_final', list(~ case_when(is.na(cat_final) & !is.na(join_cat_final) ~ join_cat_final,
                                          TRUE ~ .))) %>%
  select(-starts_with('join'))
```

Check the remaining ones.

```{r}
rc_ethnicity %>%
  filter(is.na(cat_final), !is.na(read_term)) %>%
  select(read_term) %>%
  print(n=20)
```

Manually sort out the reamaining ones.

```{r}
rc_ethnicity <- rc_ethnicity %>%
  mutate_at('cat_final', list(~ case_when(!is.na(cat_final) ~ .,
                                          is.na(cat_final) & read_term %in% c('Mid East (excl Israeli  Iranian & Arab) - eth cat 2001 cens') ~ 'Other',
                                          is.na(cat_final) & read_term %in% c('Asian: Indian Indian Scot/Indian Brit- Scotland 2011 census',
                                                           'Bangladeshi Bangladeshi Scot or Bangladeshi Brit- Scot 2011') ~ 'Asian British',
                                          TRUE ~ NA_character_))) %>%
  filter(!is.na(cat_final))
```